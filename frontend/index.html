<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>C·ª≠a H√†ng Online - Full Stack</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.6.2/axios.min.js"></script>
</head>
<body class="bg-gray-100 min-h-screen">

    <nav class="bg-blue-600 text-white p-4 shadow-md">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-2xl font-bold cursor-pointer" onclick="showSection('home')">üõí Simple Shop</h1>
            <div id="nav-buttons"></div>
        </div>
    </nav>

    <main class="container mx-auto p-4 mt-4">

        <div id="section-home" class="block">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-3xl font-bold text-gray-800">S·∫£n Ph·∫©m M·ªõi</h2>
                <button id="btn-add-product" onclick="showSection('add-product')" class="hidden bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded">
                    + Th√™m (Admin)
                </button>
            </div>
            <div id="product-list" class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-6">
                <p class="text-gray-500">ƒêang t·∫£i...</p>
            </div>
        </div>

        <div id="section-login" class="hidden max-w-md mx-auto bg-white p-8 rounded shadow-md mt-10">
            <h2 class="text-2xl font-bold mb-6 text-center">ƒêƒÉng Nh·∫≠p</h2>
            <form onsubmit="handleLogin(event)">
                <div class="mb-4">
                    <label class="block mb-2">T√™n ƒëƒÉng nh·∫≠p</label>
                    <input type="text" id="login-username" class="w-full p-2 border rounded" required>
                </div>
                <div class="mb-6">
                    <label class="block mb-2">M·∫≠t kh·∫©u</label>
                    <input type="password" id="login-password" class="w-full p-2 border rounded" required>
                </div>
                <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded hover:bg-blue-700">ƒêƒÉng Nh·∫≠p</button>
            </form>
            <p class="mt-4 text-center">Ch∆∞a c√≥ t√†i kho·∫£n? <a href="#" onclick="showSection('register')" class="text-blue-500">ƒêƒÉng k√Ω ngay</a></p>
        </div>

        <div id="section-register" class="hidden max-w-md mx-auto bg-white p-8 rounded shadow-md mt-10">
            <h2 class="text-2xl font-bold mb-6 text-center">ƒêƒÉng K√Ω T√†i Kho·∫£n</h2>
            <form onsubmit="handleRegister(event)">
                <div class="mb-3">
                    <label class="block mb-1 text-sm font-bold">T√™n ng∆∞·ªùi d√πng</label>
                    <input type="text" id="reg-username" class="w-full p-2 border rounded" required placeholder="V√≠ d·ª•: baoanh123">
                </div>
                
                <div class="mb-3">
                    <label class="block mb-1 text-sm font-bold">M·∫≠t kh·∫©u</label>
                    <input type="password" id="reg-password" class="w-full p-2 border rounded" required>
                </div>

                <div class="mb-3">
                    <label class="block mb-1 text-sm font-bold">Nh·∫≠p l·∫°i m·∫≠t kh·∫©u</label>
                    <input type="password" id="reg-confirm-pass" class="w-full p-2 border rounded" required>
                    <p id="pass-error" class="text-red-500 text-xs mt-1 hidden">M·∫≠t kh·∫©u kh√¥ng kh·ªõp!</p>
                </div>

                <div class="mb-3">
                    <label class="block mb-1 text-sm font-bold">S·ªë ƒëi·ªán tho·∫°i</label>
                    <input type="text" id="reg-phone" class="w-full p-2 border rounded" required placeholder="09xxxxxxxx">
                </div>

                <div class="mb-6">
                    <label class="block mb-1 text-sm font-bold">ƒê·ªãa ch·ªâ Email</label>
                    <input type="email" id="reg-email" class="w-full p-2 border rounded" required placeholder="abc@gmail.com">
                </div>

                <button type="submit" class="w-full bg-green-500 text-white py-2 rounded hover:bg-green-600">ƒêƒÉng K√Ω Th√†nh Vi√™n</button>
            </form>
            <p class="mt-4 text-center">ƒê√£ c√≥ t√†i kho·∫£n? <a href="#" onclick="showSection('login')" class="text-blue-500">ƒêƒÉng nh·∫≠p</a></p>
        </div>

        <div id="section-add-product" class="hidden max-w-md mx-auto bg-white p-8 rounded shadow-md mt-10">
            <h2 class="text-2xl font-bold mb-6 text-center">Th√™m S·∫£n Ph·∫©m M·ªõi</h2>
            <form onsubmit="handleAddProduct(event)">
                <div class="mb-4">
                    <label class="block mb-2">T√™n s·∫£n ph·∫©m</label>
                    <input type="text" id="prod-name" class="w-full p-2 border rounded" required>
                </div>
                <div class="mb-4">
                    <label class="block mb-2">Gi√° ($)</label>
                    <input type="number" id="prod-price" class="w-full p-2 border rounded" required>
                </div>
                <div class="mb-6">
                    <label class="block mb-2">M√¥ t·∫£</label>
                    <textarea id="prod-desc" class="w-full p-2 border rounded"></textarea>
                </div>
                <button type="submit" class="w-full bg-purple-600 text-white py-2 rounded hover:bg-purple-700">L∆∞u S·∫£n Ph·∫©m</button>
                <button type="button" onclick="showSection('home')" class="w-full mt-2 bg-gray-300 text-gray-700 py-2 rounded">H·ªßy</button>
            </form>
        </div>

    </main>

    <script>
        // --- C·∫§U H√åNH API ---
        const API_URL = "https://cuahangonline.onrender.com"; 

        // --- BI·∫æN TO√ÄN C·ª§C ---
        let currentUser = null;
        let token = localStorage.getItem('access_token');

        // --- KH·ªûI CH·∫†Y ---
        document.addEventListener('DOMContentLoaded', () => {
            checkLoginStatus();
            loadProducts();
        });

        // --- 1. X·ª¨ L√ù ƒêƒÇNG K√ù ---
        async function handleRegister(e) {
            e.preventDefault();
            const username = document.getElementById('reg-username').value;
            const password = document.getElementById('reg-password').value;
            const confirmPass = document.getElementById('reg-confirm-pass').value;
            const phone = document.getElementById('reg-phone').value;
            const email = document.getElementById('reg-email').value;

            // Ki·ªÉm tra kh·ªõp m·∫≠t kh·∫©u
            if (password !== confirmPass) {
                document.getElementById('pass-error').classList.remove('hidden');
                return;
            } else {
                document.getElementById('pass-error').classList.add('hidden');
            }

            try {
                // G·ª≠i d·ªØ li·ªáu l√™n Backend
                // L∆∞u √Ω: ƒê√£ b·ªè birthdate v√¨ Backend ch∆∞a h·ªó tr·ª£
                await axios.post(`${API_URL}/register`, { 
                    username, 
                    password, 
                    phone, 
                    email 
                });
                alert("ƒêƒÉng k√Ω th√†nh c√¥ng! B·∫°n ƒë√£ l√† Th√†nh vi√™n.");
                showSection('login');
            } catch (error) {
                console.error(error);
                alert("ƒêƒÉng k√Ω th·∫•t b·∫°i: " + (error.response?.data?.detail || "L·ªói server ho·∫∑c t√™n ƒë√£ t·ªìn t·∫°i"));
            }
        }

        // --- 2. X·ª¨ L√ù ƒêƒÇNG NH·∫¨P ---
        async function handleLogin(e) {
            e.preventDefault();
            const username = document.getElementById('login-username').value;
            const password = document.getElementById('login-password').value;
            
            const formData = new URLSearchParams();
            formData.append('username', username);
            formData.append('password', password);

            try {
                const response = await axios.post(`${API_URL}/token`, formData);
                localStorage.setItem('access_token', response.data.access_token);
                token = response.data.access_token; // C·∫≠p nh·∫≠t bi·∫øn token ngay
                alert("ƒêƒÉng nh·∫≠p th√†nh c√¥ng!");
                showSection('home');
                checkLoginStatus();
            } catch (error) {
                alert("Sai t√†i kho·∫£n ho·∫∑c m·∫≠t kh·∫©u!");
            }
        }

        // --- 3. KI·ªÇM TRA TR·∫†NG TH√ÅI ƒêƒÇNG NH·∫¨P ---
        async function checkLoginStatus() {
            token = localStorage.getItem('access_token');
            const navButtons = document.getElementById('nav-buttons');
            const btnAddProduct = document.getElementById('btn-add-product');

            if (token) {
                try {
                    const response = await axios.get(`${API_URL}/users/me`, {
                        headers: { Authorization: `Bearer ${token}` }
                    });
                    currentUser = response.data;

                    // Header khi ƒë√£ ƒëƒÉng nh·∫≠p
                    navButtons.innerHTML = `
                        <div class="text-right flex items-center gap-4">
                            <span class="text-sm">Xin ch√†o, <b>${currentUser.username}</b></span>
                            <button onclick="logout()" class="text-red-200 text-xs hover:text-white border border-red-200 px-2 py-1 rounded">ƒêƒÉng xu·∫•t</button>
                        </div>
                    `;

                    // Hi·ªán n√∫t th√™m n·∫øu l√† Admin
                    if (currentUser.role === 'admin') {
                        btnAddProduct.classList.remove('hidden');
                    } else {
                        btnAddProduct.classList.add('hidden');
                    }

                } catch (error) {
                    console.log("Token h·∫øt h·∫°n ho·∫∑c l·ªói");
                    logout();
                }
            } else {
                // Header khi ch∆∞a ƒëƒÉng nh·∫≠p
                navButtons.innerHTML = `
                    <button onclick="showSection('login')" class="bg-white text-blue-600 px-4 py-2 rounded font-semibold mr-2">ƒêƒÉng Nh·∫≠p</button>
                    <button onclick="showSection('register')" class="border border-white px-4 py-2 rounded font-semibold hover:bg-blue-700">ƒêƒÉng K√Ω</button>
                `;
                btnAddProduct.classList.add('hidden');
            }
        }

        function logout() {
            localStorage.removeItem('access_token');
            token = null;
            currentUser = null;
            location.reload();
        }

        // --- 4. T·∫¢I S·∫¢N PH·∫®M ---
        async function loadProducts() {
            try {
                const response = await axios.get(`${API_URL}/products`);
                const list = document.getElementById('product-list');
                list.innerHTML = '';

                response.data.forEach(p => {
                    const deleteBtn = (currentUser && currentUser.role === 'admin') 
                        ? `<button onclick="deleteProduct(${p.id})" class="text-red-500 text-sm mt-2 underline ml-auto block">X√≥a</button>` 
                        : '';

                    list.innerHTML += `
                        <div class="bg-white p-4 rounded shadow hover:shadow-lg transition">
                            <div class="h-40 bg-gray-200 flex items-center justify-center text-4xl mb-4">üì¶</div>
                            <h3 class="font-bold text-lg">${p.name}</h3>
                            <p class="text-gray-600 text-sm">${p.description}</p>
                            <div class="flex justify-between items-center mt-4 border-t pt-2">
                                <span class="text-blue-600 font-bold text-xl">$${p.price}</span>
                                <button onclick="alert('T√≠nh nƒÉng gi·ªè h√†ng ƒëang c·∫≠p nh·∫≠t!')" class="bg-blue-100 text-blue-600 px-3 py-1 rounded text-sm hover:bg-blue-200">Mua</button>
                            </div>
                            ${deleteBtn}
                        </div>
                    `;
                });
            } catch (error) {
                console.error(error);
                document.getElementById('product-list').innerHTML = '<p class="text-red-500">Kh√¥ng t·∫£i ƒë∆∞·ª£c s·∫£n ph·∫©m.</p>';
            }
        }

        // --- 5. TH√äM S·∫¢N PH·∫®M (ADMIN) ---
        async function handleAddProduct(e) {
            e.preventDefault();
            const name = document.getElementById('prod-name').value;
            const price = document.getElementById('prod-price').value;
            const desc = document.getElementById('prod-desc').value;
            try {
                await axios.post(`${API_URL}/products`, {
                    name, price: parseFloat(price), description: desc
                }, { headers: { Authorization: `Bearer ${token}` } });
                alert("Th√™m s·∫£n ph·∫©m th√†nh c√¥ng!");
                showSection('home');
                loadProducts();
            } catch (error) { alert("L·ªói: B·∫°n kh√¥ng c√≥ quy·ªÅn Admin!"); }
        }

        // --- 6. X√ìA S·∫¢N PH·∫®M (ADMIN) ---
        async function deleteProduct(id) {
            if (!confirm("B·∫°n ch·∫Øc ch·∫Øn mu·ªën x√≥a?")) return;
            try {
                await axios.delete(`${API_URL}/products/${id}`, {
                    headers: { Authorization: `Bearer ${token}` }
                });
                loadProducts();
            } catch (error) { alert("L·ªói khi x√≥a!"); }
        }

        // --- H√ÄM CHUY·ªÇN TRANG ---
        function showSection(sectionId) {
            // ·∫®n t·∫•t c·∫£ section
            ['home', 'login', 'register', 'add-product'].forEach(id => {
                const el = document.getElementById(`section-${id}`);
                if (el) el.classList.add('hidden');
            });
            // Hi·ªán section c·∫ßn thi·∫øt
            const target = document.getElementById(`section-${sectionId}`);
            if (target) target.classList.remove('hidden');
            
            if (sectionId === 'home') loadProducts();
        }
    </script>
</body>
</html>