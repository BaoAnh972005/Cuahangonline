<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cá»­a HÃ ng Online - Full Stack</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.6.2/axios.min.js"></script>
</head>
<body class="bg-gray-100 min-h-screen">

    <nav class="bg-blue-600 text-white p-4 shadow-md">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-2xl font-bold cursor-pointer" onclick="showSection('home')">ğŸ›’ Simple Shop</h1>
            
            <div id="nav-buttons">
                </div>
        </div>
    </nav>

    <main class="container mx-auto p-4 mt-4">

        <div id="section-home" class="block">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-3xl font-bold text-gray-800">Sáº£n Pháº©m Má»›i</h2>
                <button id="btn-add-product" onclick="showSection('add-product')" class="hidden bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded">
                    + ThÃªm Sáº£n Pháº©m (Admin)
                </button>
            </div>
            
            <div id="product-list" class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-6">
                <p class="text-gray-500">Äang táº£i...</p>
            </div>
        </div>

        <div id="section-login" class="hidden max-w-md mx-auto bg-white p-8 rounded shadow-md mt-10">
            <h2 class="text-2xl font-bold mb-6 text-center">ÄÄƒng Nháº­p</h2>
            <form onsubmit="handleLogin(event)">
                <div class="mb-4">
                    <label class="block mb-2">TÃªn Ä‘Äƒng nháº­p</label>
                    <input type="text" id="login-username" class="w-full p-2 border rounded" required>
                </div>
                <div class="mb-6">
                    <label class="block mb-2">Máº­t kháº©u</label>
                    <input type="password" id="login-password" class="w-full p-2 border rounded" required>
                </div>
                <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded hover:bg-blue-700">ÄÄƒng Nháº­p</button>
            </form>
            <p class="mt-4 text-center">ChÆ°a cÃ³ tÃ i khoáº£n? <a href="#" onclick="showSection('register')" class="text-blue-500">ÄÄƒng kÃ½ ngay</a></p>
        </div>

        <div id="section-register" class="hidden max-w-md mx-auto bg-white p-8 rounded shadow-md mt-10">
            <h2 class="text-2xl font-bold mb-6 text-center">ÄÄƒng KÃ½ TÃ i Khoáº£n</h2>
            <form onsubmit="handleRegister(event)">
                <div class="mb-4">
                    <label class="block mb-2">TÃªn Ä‘Äƒng nháº­p</label>
                    <input type="text" id="reg-username" class="w-full p-2 border rounded" required>
                </div>
                <div class="mb-4">
                    <label class="block mb-2">Máº­t kháº©u</label>
                    <input type="password" id="reg-password" class="w-full p-2 border rounded" required>
                </div>
                <div class="mb-6">
                    <label class="block mb-2">Vai trÃ² (Test Only)</label>
                    <select id="reg-role" class="w-full p-2 border rounded">
                        <option value="member">ThÃ nh viÃªn (Member)</option>
                        <option value="admin">Quáº£n lÃ½ (Admin)</option>
                    </select>
                </div>
                <button type="submit" class="w-full bg-green-500 text-white py-2 rounded hover:bg-green-600">ÄÄƒng KÃ½</button>
            </form>
            <p class="mt-4 text-center">ÄÃ£ cÃ³ tÃ i khoáº£n? <a href="#" onclick="showSection('login')" class="text-blue-500">ÄÄƒng nháº­p</a></p>
        </div>

        <div id="section-add-product" class="hidden max-w-md mx-auto bg-white p-8 rounded shadow-md mt-10">
            <h2 class="text-2xl font-bold mb-6 text-center">ThÃªm Sáº£n Pháº©m Má»›i</h2>
            <form onsubmit="handleAddProduct(event)">
                <div class="mb-4">
                    <label class="block mb-2">TÃªn sáº£n pháº©m</label>
                    <input type="text" id="prod-name" class="w-full p-2 border rounded" required>
                </div>
                <div class="mb-4">
                    <label class="block mb-2">GiÃ¡ ($)</label>
                    <input type="number" id="prod-price" class="w-full p-2 border rounded" required>
                </div>
                <div class="mb-6">
                    <label class="block mb-2">MÃ´ táº£</label>
                    <textarea id="prod-desc" class="w-full p-2 border rounded"></textarea>
                </div>
                <button type="submit" class="w-full bg-purple-600 text-white py-2 rounded hover:bg-purple-700">LÆ°u Sáº£n Pháº©m</button>
                <button type="button" onclick="showSection('home')" class="w-full mt-2 bg-gray-300 text-gray-700 py-2 rounded">Há»§y</button>
            </form>
        </div>

    </main>

    <script>
        // --- Cáº¤U HÃŒNH ---
        // Thay link Render cá»§a báº¡n vÃ o Ä‘Ã¢y (khÃ´ng cÃ³ dáº¥u / á»Ÿ cuá»‘i)
        const API_URL = "https://cuahangonline.onrender.com"; 

        // --- BIáº¾N TOÃ€N Cá»¤C ---
        let currentUser = null; // LÆ°u thÃ´ng tin ngÆ°á»i dÃ¹ng Ä‘ang Ä‘Äƒng nháº­p
        let token = localStorage.getItem('access_token'); // Láº¥y token tá»« bá»™ nhá»› trÃ¬nh duyá»‡t

        // --- KHá»I CHáº Y ---
        document.addEventListener('DOMContentLoaded', () => {
            checkLoginStatus(); // Kiá»ƒm tra xem Ä‘Ã£ Ä‘Äƒng nháº­p chÆ°a
            loadProducts();     // Táº£i danh sÃ¡ch sáº£n pháº©m
        });

        // --- CÃC HÃ€M Xá»¬ LÃ LOGIC ---

        // 1. Kiá»ƒm tra tráº¡ng thÃ¡i Ä‘Äƒng nháº­p
        async function checkLoginStatus() {
            token = localStorage.getItem('access_token');
            const navButtons = document.getElementById('nav-buttons');
            const btnAddProduct = document.getElementById('btn-add-product');

            if (token) {
                // ÄÃ£ Ä‘Äƒng nháº­p: Gá»i API Ä‘á»ƒ láº¥y thÃ´ng tin user (Role)
                try {
                    const response = await axios.get(`${API_URL}/users/me`, {
                        headers: { Authorization: `Bearer ${token}` }
                    });
                    currentUser = response.data;

                    // Cáº­p nháº­t giao diá»‡n Header
                    navButtons.innerHTML = `
                        <span class="mr-4">Xin chÃ o, <b>${currentUser.username}</b> (${currentUser.role})</span>
                        <button onclick="logout()" class="bg-red-500 hover:bg-red-600 px-3 py-1 rounded">ÄÄƒng xuáº¥t</button>
                    `;

                    // Náº¿u lÃ  Admin thÃ¬ hiá»‡n nÃºt ThÃªm sáº£n pháº©m
                    if (currentUser.role === 'admin') {
                        btnAddProduct.classList.remove('hidden');
                    } else {
                        btnAddProduct.classList.add('hidden');
                    }

                } catch (error) {
                    // Token lá»—i hoáº·c háº¿t háº¡n
                    logout();
                }
            } else {
                // ChÆ°a Ä‘Äƒng nháº­p
                navButtons.innerHTML = `
                    <button onclick="showSection('login')" class="bg-white text-blue-600 px-4 py-2 rounded font-semibold mr-2">ÄÄƒng Nháº­p</button>
                    <button onclick="showSection('register')" class="border border-white px-4 py-2 rounded font-semibold hover:bg-blue-700">ÄÄƒng KÃ½</button>
                `;
                btnAddProduct.classList.add('hidden');
            }
        }

        // 2. ÄÄƒng kÃ½
        async function handleRegister(e) {
            e.preventDefault();
            const username = document.getElementById('reg-username').value;
            const password = document.getElementById('reg-password').value;
            const role = document.getElementById('reg-role').value;

            try {
                // BÆ°á»›c 1: Gá»i API ÄÄƒng kÃ½
                await axios.post(`${API_URL}/register`, { username, password, role });
                alert("ÄÄƒng kÃ½ thÃ nh cÃ´ng! HÃ£y Ä‘Äƒng nháº­p.");
                showSection('login');
            } catch (error) {
                alert("ÄÄƒng kÃ½ tháº¥t báº¡i: " + (error.response?.data?.detail || "Lá»—i khÃ´ng xÃ¡c Ä‘á»‹nh"));
            }
        }

        // 3. ÄÄƒng nháº­p
        async function handleLogin(e) {
            e.preventDefault();
            const username = document.getElementById('login-username').value;
            const password = document.getElementById('login-password').value;

            // Form data chuáº©n OAuth2
            const formData = new URLSearchParams();
            formData.append('username', username);
            formData.append('password', password);

            try {
                const response = await axios.post(`${API_URL}/token`, formData);
                // LÆ°u token vÃ o mÃ¡y
                localStorage.setItem('access_token', response.data.access_token);
                alert("ÄÄƒng nháº­p thÃ nh cÃ´ng!");
                
                // Reset giao diá»‡n
                showSection('home');
                checkLoginStatus();
            } catch (error) {
                alert("Sai tÃ i khoáº£n hoáº·c máº­t kháº©u!");
            }
        }

        // 4. ÄÄƒng xuáº¥t
        function logout() {
            localStorage.removeItem('access_token');
            currentUser = null;
            location.reload(); // Táº£i láº¡i trang cho sáº¡ch
        }

        // 5. Táº£i danh sÃ¡ch sáº£n pháº©m
        async function loadProducts() {
            try {
                const response = await axios.get(`${API_URL}/products`);
                const list = document.getElementById('product-list');
                list.innerHTML = '';

                response.data.forEach(p => {
                    // Náº¿u lÃ  Admin thÃ¬ hiá»‡n nÃºt XÃ³a
                    const deleteBtn = (currentUser && currentUser.role === 'admin') 
                        ? `<button onclick="deleteProduct(${p.id})" class="text-red-500 text-sm mt-2 underline">XÃ³a (Admin)</button>` 
                        : '';

                    list.innerHTML += `
                        <div class="bg-white p-4 rounded shadow hover:shadow-lg transition">
                            <div class="h-40 bg-gray-200 flex items-center justify-center text-4xl mb-4">ğŸ“¦</div>
                            <h3 class="font-bold text-lg">${p.name}</h3>
                            <p class="text-gray-600 text-sm">${p.description}</p>
                            <div class="flex justify-between items-center mt-4">
                                <span class="text-blue-600 font-bold">$${p.price}</span>
                                ${deleteBtn}
                            </div>
                        </div>
                    `;
                });
            } catch (error) {
                console.error(error);
            }
        }

        // 6. ThÃªm sáº£n pháº©m (Chá»‰ Admin)
        async function handleAddProduct(e) {
            e.preventDefault();
            const name = document.getElementById('prod-name').value;
            const price = document.getElementById('prod-price').value;
            const desc = document.getElementById('prod-desc').value;

            try {
                await axios.post(`${API_URL}/products`, {
                    name: name,
                    price: parseFloat(price),
                    description: desc
                }, {
                    headers: { Authorization: `Bearer ${token}` } // Gá»­i kÃ¨m Token chá»©ng minh lÃ  Admin
                });
                alert("ThÃªm sáº£n pháº©m thÃ nh cÃ´ng!");
                showSection('home');
                loadProducts();
            } catch (error) {
                alert("Lá»—i: Báº¡n khÃ´ng cÃ³ quyá»n Admin!");
            }
        }

        // 7. XÃ³a sáº£n pháº©m (Chá»‰ Admin)
        async function deleteProduct(id) {
            if (!confirm("Báº¡n cháº¯c cháº¯n muá»‘n xÃ³a sáº£n pháº©m nÃ y?")) return;

            try {
                await axios.delete(`${API_URL}/products/${id}`, {
                    headers: { Authorization: `Bearer ${token}` }
                });
                alert("ÄÃ£ xÃ³a!");
                loadProducts();
            } catch (error) {
                alert("Lá»—i: KhÃ´ng xÃ³a Ä‘Æ°á»£c!");
            }
        }

        // --- HÃ€M TIá»†N ÃCH CHUYá»‚N TAB ---
        function showSection(sectionId) {
            // áº¨n táº¥t cáº£ section
            ['home', 'login', 'register', 'add-product'].forEach(id => {
                document.getElementById(`section-${id}`).classList.add('hidden');
            });
            // Hiá»‡n section Ä‘Æ°á»£c chá»n
            document.getElementById(`section-${sectionId}`).classList.remove('hidden');
            
            if (sectionId === 'home') loadProducts();
        }
    </script>
</body>
</html>